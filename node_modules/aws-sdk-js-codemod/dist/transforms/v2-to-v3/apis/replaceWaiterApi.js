"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.replaceWaiterApi = void 0;
const getArgsWithoutWaiterConfig_1 = require("./getArgsWithoutWaiterConfig");
const getClientIdentifiers_1 = require("./getClientIdentifiers");
const getClientWaiterCallExpression_1 = require("./getClientWaiterCallExpression");
const getClientWaiterStates_1 = require("./getClientWaiterStates");
const getV3ClientWaiterApiName_1 = require("./getV3ClientWaiterApiName");
const getWaiterConfig_1 = require("./getWaiterConfig");
const getWaiterConfigValue_1 = require("./getWaiterConfigValue");
// Updates .waitFor() API with waitUntil* API.
const replaceWaiterApi = (j, source, options) => {
    const clientIdentifiers = (0, getClientIdentifiers_1.getClientIdentifiers)(j, source, options);
    for (const clientId of clientIdentifiers) {
        const waiterStates = (0, getClientWaiterStates_1.getClientWaiterStates)(j, source, options);
        for (const waiterState of waiterStates) {
            const v3WaiterApiName = (0, getV3ClientWaiterApiName_1.getV3ClientWaiterApiName)(waiterState);
            source
                .find(j.CallExpression, (0, getClientWaiterCallExpression_1.getClientWaiterCallExpression)(clientId, waiterState))
                .replaceWith((callExpression) => {
                const waiterConfig = (0, getWaiterConfig_1.getWaiterConfig)(callExpression.node.arguments[1]);
                const delay = (0, getWaiterConfigValue_1.getWaiterConfigValue)(waiterConfig, "delay");
                const maxAttempts = (0, getWaiterConfigValue_1.getWaiterConfigValue)(waiterConfig, "maxAttempts");
                const properties = [];
                properties.push(j.objectProperty.from({
                    key: j.identifier("client"),
                    value: clientId,
                    shorthand: true,
                }));
                if (delay) {
                    properties.push(j.objectProperty.from({
                        key: j.identifier("minDelay"),
                        value: j.numericLiteral(Number(delay)),
                    }));
                }
                const delayForWaitTime = delay ? Number(delay) : 10;
                const maxAttemptsForWaitTime = maxAttempts ? Number(maxAttempts) : 10;
                const maxWaitTime = 2 * delayForWaitTime * maxAttemptsForWaitTime;
                properties.push(j.objectProperty.from({
                    key: j.identifier("maxWaitTime"),
                    value: j.numericLiteral(maxWaitTime),
                }));
                return j.callExpression(j.identifier(v3WaiterApiName), [
                    j.objectExpression(properties),
                    (0, getArgsWithoutWaiterConfig_1.getArgsWithoutWaiterConfig)(callExpression.node.arguments[1]),
                ]);
            });
        }
    }
};
exports.replaceWaiterApi = replaceWaiterApi;
